---
title: 'Perturbseq数据分析中的遇到的问题记录'
date: 2025-03-18
permalink: /posts/2025/03/blog-post-2/
tags:
  - mixscape contrastiveVI NMF scenic decoupleR
  - python
  - perturbseq
---

近期在做perturbseq的数据分析，过程中比较不顺利，在此记录一下学习/踩坑的过程.


mixscape的原理以及潜在的问题
----
计算的原理
对于每一个perturbed cell $p \in P $，基因 $g \in G$ 的表达量为$E_{p,g}$。对于non-targeting control cells $C$，表达矩阵为$E_{C,G}$。$\forall p \in P$，最近的$ n $个non-targeting control cells组成的集合为: 
$$
NN_{p,n} = fnNN(n, E_{p,G}, E_{C,G})
$$
$fnNN()$在实际计算中，使用python中scanpy包，基于表达矩阵$E$,进行PCA+UMAP计算，再用pynndescent包计算得到。
$\forall p \in P$, $\forall g \in G$, perturbation signature计算为：
$$
S_{p,g} = E_{p,g} - \frac{1}{n} (\sum_{i \in NN_{p,n}} E_{i,g} )
$$
对于所有的perturbed cell $P$, 其中对基因$k$的KO的细胞组成集合$P_{k}$。对于$\forall k \in K$,差异表达基因为 $$D_{k} = DEG( E_{ P_{k}, G },E_{C, G})$$
$DEG()$在实际计算中，基于表达矩阵$E$，使用scanpy包中的rank_gene_groups函数进行计算

mixscape的基本假设是：$P_{k}$中的细胞有两种状态，一种是perturbation成功扰动了细胞表达谱的。另外一种是none-perturbed，就算是检测到了sgRNA，但是没有对细胞的表达谱造成扰动，其状态跟non-targeting control cells $C$更接近。所以理论上，假设细胞的状态分为两组：$NPC$和$PC$，
对细胞分群的初始化值为：$PC = P_{k}$, $NPC=C$，使用EM算法，迭代优化PC和NPC的分类，将$PC$群中perturbation score ($PS$)更接近$NPC$群$PS$分布的细胞划分至NPC群，直至结果收敛。迭代过程如下：

$PC$中细胞个数为$count(PC)$, $NPC$中细胞个数为$count(NPC)$
$$DIFF(PC,NPC) = \frac{1}{count(PC)}\sum_{x \in PC}^{} E_{x,D_{k}} - \frac{1}{count(NPC)}\sum_{x \in NPC}^{} E_{x,D_{k}} $$
$ \forall x \in PC\cup NPC$, perturbation score $$PS(x|(PC,NPC)) = (\sum_{j\in D_{k} } E_{x,j}* DIFF(PC,NPC)_{j}) \frac{1}{  \sum_{j\in D_{k} } (DIFF(PC,NPC)_{j})^2 }$$

基于PC和NPC细胞群的perturbation score $PS$， 计算其高斯分布的参数$\mu$和$\sigma$
$\mu_{NPC} = mean(PS( NPC|(PC,NPC))) , \sigma_{NPC}=VAR(PS(NPC|(PC,NPC)))$
$\mu_{PC} = mean(PS(PC|(PC,NPC))) , \sigma_{PC}=VAR(PS(PC|(PC,NPC)))$

$\forall x \in PC$,检查其perturbation score$PS(x|(PC,NPC))$是否更可能采样自$PS(NPC|(PC,NPC))$的分布:
 $$LIKELYHOOD_{x}= \frac {N(PS(x|(PC,NPC))|\mu_{PC},\sigma_{PC})}{N(PS(x|(PC,NPC))|\mu_{NPC},\sigma_{NPC})} $$
$$POST_{x} = \frac{1}{1+LIKELYHOOD_{x}}$$
如果检查结果是肯定的(即：$POST_{x}> THRESHOLD$)，则将$x$从$PC$集合中移除，添加到$NPC$集合中：
$PC' = PC\setminus \left\{x\middle | POST_{x} \gt THRESHOLD\right\}$
$NPC' = NPC\cup \left\{x\middle | POST_{x} \le THRESHOLD\right\}$
更新$PC=PC'$与$NPC=NPC'$后，进行下一轮的计算


其中的问题：
1. 理想情况下，PC与NPC的细胞的PS分别服从各自的高斯分布。考虑某些细胞虽然检测到sgRNA但是可能实际上没有敲除成功，那么PC中有一部分细胞类似NPC的细胞群，那么可以将PC中类似NPC的细胞重新划入NPC中，可以将剩余的具有显著敲除效应的细胞分出来。但是实际情况中，




基于细胞系的perturbseq的问题
----
因为细胞系的细胞是高度的异质的，所以敲除掉目标基因后，给细胞的表达谱带来的影响有可能没有异质性带来的影响显著。这就导致，在进行PCA/UMAP/TSNE降维可视化时候，不同基因敲除后的细胞聚集在一起。此现象也有文献报导过，并且提供有相关的方法可以用来去除细胞系异质性的影响。
> 文献1
> 文献2



perturbseq数据鉴定gene program
----

